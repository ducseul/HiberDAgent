# ProGuard configuration for HiberDAgent
# Obfuscation and optimization settings

# Keep the agent entry points
-keep public class com.ducseul.agent.hiberdagent.HiberDAgent {
    public static void premain(java.lang.String, java.lang.instrument.Instrumentation);
    public static void main(java.lang.String[]);
}

# Keep ByteBuddy advice classes - MUST preserve exact bytecode structure
# These classes are inlined by ByteBuddy at runtime, any modification breaks frame computation
-keep,allowobfuscation class com.ducseul.agent.hiberdagent.advice.** { *; }
-keepclassmembers,allowobfuscation class com.ducseul.agent.hiberdagent.advice.** { *; }

# Keep wrapper classes used for JDBC instrumentation
-keep,allowobfuscation class com.ducseul.agent.hiberdagent.wrapper.** { *; }
-keepclassmembers,allowobfuscation class com.ducseul.agent.hiberdagent.wrapper.** { *; }

# Keep public API of config and entities
-keep class com.ducseul.agent.hiberdagent.config.AgentConfig {
    public static *;
}
-keep class com.ducseul.agent.hiberdagent.entity.** { *; }

# Keep security/integrity checker public methods
-keep class com.ducseul.agent.hiberdagent.security.IntegrityChecker {
    public static *;
}

# Remove build-time utility (not needed at runtime)
-assumenosideeffects class com.ducseul.agent.hiberdagent.security.HashGenerator { *; }

# Keep log writer public methods
-keep class com.ducseul.agent.hiberdagent.log.SqlLogWriter {
    public static *;
}

# Keep SQL formatter public methods
-keep class com.ducseul.agent.hiberdagent.format.SqlFormatter {
    public static *;
}

# Keep license verifier
-keep class com.ducseul.agent.hiberdagent.config.LicenseVerifier { *; }

# Preserve annotations used by ByteBuddy
-keepattributes *Annotation*
-keepattributes Signature
-keepattributes InnerClasses
-keepattributes EnclosingMethod

# Keep shaded ByteBuddy classes intact - critical for agent functionality
-keep class com.ducseul.agent.shaded.bytebuddy.** { *; }
-dontwarn com.ducseul.agent.shaded.bytebuddy.**

# Ignore missing JNA classes used by ByteBuddy agent
-dontwarn com.sun.jna.**
-dontwarn net.bytebuddy.**

# Don't optimize or shrink ByteBuddy code to avoid class hierarchy issues
-keep class com.ducseul.agent.shaded.bytebuddy.** { *; }

# Ignore class hierarchy warnings for missing libraries
-ignorewarnings

# Obfuscation settings
-obfuscationdictionary proguard-dict.txt
-classobfuscationdictionary proguard-dict.txt
-packageobfuscationdictionary proguard-dict.txt

# CRITICAL: Disable optimization and preverification to preserve ByteBuddy advice bytecode
# ProGuard's optimization/preverification modifies stack frames which breaks ByteBuddy inlining
-dontoptimize
-dontpreverify

-allowaccessmodification

# Don't warn about missing classes from JDK
-dontwarn java.**
-dontwarn javax.**
-dontwarn sun.**

# Suppress notes about duplicate class definitions
-dontnote **

# Keep line numbers for stack traces (optional - remove for full obfuscation)
# -keepattributes SourceFile,LineNumberTable

# Rename source file attribute to hide original filenames
-renamesourcefileattribute SourceFile
