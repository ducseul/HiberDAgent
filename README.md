# HiberDAgent

A lightweight Java agent that intercepts and logs SQL queries executed through Hibernate/JDBC with parameter values filled in. Perfect for debugging and performance analysis.

## Features

- **SQL Logging with Parameters** - Logs actual SQL with parameter values substituted (no more `?` placeholders)
- **Execution Time Tracking** - Shows how long each query takes
- **Stack Trace Correlation** - Identifies which code triggered each query with unique query IDs
- **Package Filtering** - Filter stack traces to show only your application code
- **Oracle Compatible** - Formats dates/timestamps for Oracle (`TO_DATE`, `TO_TIMESTAMP`)
- **Batch Support** - Logs batch operations with statement counts

## Build

**Development build** (faster, no obfuscation):
```bash
mvn clean package
```

**Release build** (with ProGuard obfuscation and integrity protection):
```bash
mvn clean package -P obfuscate
```

| Build Type | Output JAR | Description |
|------------|------------|-------------|
| Development | `target/HiberDAgent-1.0.jar` | Unobfuscated, for debugging |
| Release | `target/HiberDAgent-1.0-obf.jar` | Obfuscated with anti-tampering |

## Usage

Add the agent to your JVM startup arguments with a valid license:

```bash
java -javaagent:/path/to/HiberDAgent-1.0.jar \
     -Dhibernate.agent.license=/path/to/license.lic \
     -jar your-app.jar
```

**A valid license is required.** The agent will not start without one.

### Configuration Options

All options are set via system properties with the prefix `hibernate.agent.`:

| Property | Default | Description |
|----------|---------|-------------|
| `hibernate.agent.license` | *(required)* | Path to license file or license string |
| `hibernate.agent.logSqlAlways` | `true` | Log all SQL queries (not just slow ones) |
| `hibernate.agent.slowThresholdMs` | `5000` | Threshold (ms) for slow query detection |
| `hibernate.agent.logStack` | `false` | Include stack trace with each query |
| `hibernate.agent.maxStackDepth` | `10` | Maximum stack frames to show |
| `hibernate.agent.stackPackageFilter` | *(all)* | Comma-separated package prefixes to include in stack traces |
| `hibernate.agent.debug` | `false` | Enable debug logging to stderr |
| `hibernate.agent.logFile` | *(console)* | Path to log file (if not set, logs to stdout) |

### Examples

**Basic usage - log all SQL to console:**
```bash
java -javaagent:HiberDAgent-1.0.jar \
     -Dhibernate.agent.license=/path/to/license.lic \
     -jar myapp.jar
```

**Using license string directly:**
```bash
java -javaagent:HiberDAgent-1.0.jar \
     -Dhibernate.agent.license="BASE64_LICENSE_STRING" \
     -jar myapp.jar
```

**Log to file:**
```bash
java -javaagent:HiberDAgent-1.0.jar \
     -Dhibernate.agent.license=/path/to/license.lic \
     -Dhibernate.agent.logFile=/var/log/sql.log \
     -jar myapp.jar
```

**Enable stack traces showing only your code:**
```bash
java -javaagent:HiberDAgent-1.0.jar \
     -Dhibernate.agent.license=/path/to/license.lic \
     -Dhibernate.agent.logStack=true \
     -Dhibernate.agent.stackPackageFilter=com.mycompany,com.myapp \
     -jar myapp.jar
```

**Only log slow queries (>1 second):**
```bash
java -javaagent:HiberDAgent-1.0.jar \
     -Dhibernate.agent.license=/path/to/license.lic \
     -Dhibernate.agent.logSqlAlways=false \
     -Dhibernate.agent.slowThresholdMs=1000 \
     -jar myapp.jar
```

## Output Examples

### Basic SQL Log
```
[SQL] (took=45ms) SELECT * FROM users WHERE id = 123
[SQL] (took=128ms) INSERT INTO orders (user_id, total) VALUES (123, 99.99)
```

### With Stack Traces
When `-Dhibernate.agent.logStack=true`:
```
[STACK] [Q000001] com.myapp.dao.UserDao.findById(UserDao.java:45) <- com.myapp.service.UserService.getUser(UserService.java:32)
[SQL] [Q000001] (took=45ms) SELECT * FROM users WHERE id = 123
```

The query ID (`Q000001`) correlates the stack trace with the SQL statement.

### With Package Filter
When `-Dhibernate.agent.stackPackageFilter=com.myapp`:

Only frames from `com.myapp.*` packages are shown - no Hibernate, Spring, or other framework noise.

## Excluded Framework Packages

The following packages are automatically excluded from stack traces:
- `java.*`, `javax.*`, `sun.*`, `com.sun.*`
- `org.hibernate.*`
- `org.springframework.*`
- `org.apache.*`
- `org.jboss.*`, `org.wildfly.*`, `io.undertow.*`
- `org.glassfish.*`, `org.eclipse.*`
- `net.bytebuddy.*`, `javassist.*`, `cglib.*`
- Proxy classes (`$$`, `$Proxy`)

## Compatibility

- **Java**: 8+ (compiled with Java 1.8 target)
- **Hibernate**: All versions
- **Application Servers**: WildFly, Tomcat, Jetty, GlassFish, etc.

## Limitations

- **HQL/JPQL not captured** - The agent intercepts at the JDBC layer, so it logs the **final SQL** generated by Hibernate, not the original HQL/JPQL/Criteria queries. This is typically more useful for debugging since it shows exactly what runs against the database.

## Licensing

HiberDAgent requires a valid license to operate. The license is verified using RSA digital signatures.

### License Types

| Type | Cost | Usage |
|------|------|-------|
| **Personal** | Free | Non-commercial, personal projects, learning |
| **Commercial** | Paid | Commercial products, enterprise use |

To obtain a license, contact via Telegram: [@ducseul](https://t.me/ducseul)

### Providing a License

You can provide the license in two ways:

1. **File path:**
   ```bash
   -Dhibernate.agent.license=/path/to/license.lic
   ```

2. **Direct string:**
   ```bash
   -Dhibernate.agent.license="LICENSE_STRING_HERE"
   ```

### License Errors

If the license is missing, invalid, or expired, the agent will display an error and prevent the application from starting. You can contact me for retrieving free license (non-commercial):

```
================================================================================
                         HIBERDAGENT LICENSE ERROR
================================================================================

  License verification failed: [reason]

  Please provide a valid license using one of these methods:

  1. Pass license file path:
     -Dhibernate.agent.license=/path/to/license.lic

  2. Pass license string directly:
     -Dhibernate.agent.license=license-string

  Contact your administrator to obtain a valid license.

================================================================================
```

## License

Proprietary License - Free for non-commercial use.

For licensing inquiries: [@ducseul](https://t.me/ducseul)
